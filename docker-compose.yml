version: '3.8'

services:
  app:
    build: .
    ports:
      - "9999:9999"
    environment:
      - DOMAIN=${DOMAIN:-babirusa.space}
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_USER:-admin}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_PASS:-admin}
    depends_on:
      - mongo
    command: >
      sh -c "git clone https://github.com/sherstnew/babirusa.space /app &&
      cd /app &&
      python -m venv venv &&
      . venv/bin/activate &&
      pip install -r requirements.txt &&
      uvicorn app.main:app --host 0.0.0.0 --port 9999"

  mitm:
    build: .
    ports:
      - "8080:8080"
    command: >
      sh -c "cd /app &&
      . venv/bin/activate &&
      mitmdump -s mitm.py -p 8080 --set keep_host_header=true"

  nginx:
    image: nginx:latest
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf
      - certbot-etc:/etc/letsencrypt
      - certbot-var:/var/lib/letsencrypt
    depends_on:
      - mitm
      - certbot

  mongo:
    image: mongo:latest
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_USER}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_PASS}
    volumes:
      - mongo_data:/data/db
    command: >
      sh -c "mongod --auth &&
      mongo admin --eval 'db.createUser({user: \"${MONGO_USER:-admin}\", pwd: \"${MONGO_PASS:-admin}\", roles: [\"root\"]})' &&
      mongo admin -u ${MONGO_USER:-admin} -p ${MONGO_PASS:-admin} --eval 'db.getSiblingDB(\"babirusa\").createCollection(\"temp\"); db.getSiblingDB(\"babirusa-test\").createCollection(\"temp\")'"

volumes:
  mongo_data:
  certbot-etc:
  certbot-var: